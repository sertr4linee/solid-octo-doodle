generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id
  name          String
  email         String         @unique
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  accounts      Account[]
  member        Member[]
  sessions      Session[]
  teamMember    teamMember[]
  boards        Board[]
  boardMembers  BoardMember[]
  tasks         Task[]
  comments      Comment[]
  activities    Activity[]
  reactions     TaskReaction[]
  checklistItems ChecklistItem[]
  checklistTemplates ChecklistTemplate[]

  @@map("user")
}

model Session {
  id                   String   @id
  expiresAt            DateTime
  token                String   @unique
  createdAt            DateTime
  updatedAt            DateTime
  ipAddress            String?
  userAgent            String?
  userId               String
  activeOrganizationId String?
  activeTeamId         String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  expiresAt             DateTime?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime
  updatedAt  DateTime

  @@map("verification")
}

model Organization {
  id          String       @id
  name        String
  slug        String       @unique
  logo        String?
  metadata    String?
  createdAt   DateTime
  invitations Invitation[]
  members     Member[]
  team        team[]
  boards      Board[]
  integrations Integration[]
  apiKeys     ApiKey[]

  @@map("organization")
}

model Member {
  id             String       @id
  organizationId String
  userId         String
  role           String
  createdAt      DateTime
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  email          String
  role           String
  status         String
  expiresAt      DateTime
  inviterId      String
  teamId         String?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

model team {
  id             String       @id
  name           String
  organizationId String
  createdAt      DateTime
  updatedAt      DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teamMember     teamMember[]
}

model teamMember {
  id        String   @id
  teamId    String
  userId    String
  createdAt DateTime
  team      team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Boards System
model Board {
  id             String        @id
  name           String
  description    String?
  organizationId String
  createdById    String
  visibility     String        @default("private") // private, organization, public
  background     String?       // Color or image URL
  backgroundType String?       @default("color") // color, gradient, image, unsplash
  backgroundBlur Boolean       @default(false)
  theme          String?       // Theme preset name
  darkMode       Boolean       @default(false)
  starred        Boolean       @default(false)
  archived       Boolean       @default(false)
  defaultView    String        @default("kanban") // kanban, calendar, table, timeline, gallery
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User          @relation(fields: [createdById], references: [id])
  members        BoardMember[]
  lists          List[]
  activities     Activity[]
  labels         Label[]
  views          BoardView[]
  integrations   Integration[]
  emailIntegration EmailIntegration?

  @@map("board")
}

model BoardMember {
  id        String   @id
  boardId   String
  userId    String
  role      String   @default("member") // owner, admin, member
  createdAt DateTime @default(now())
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@map("board_member")
}

model List {
  id        String   @id
  name      String
  boardId   String
  position  Int
  color     String?  // Custom color for list
  emoji     String?  // Emoji icon for list
  archived  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@map("list")
}

model Task {
  id          String         @id
  title       String
  description String?
  listId      String
  position    Int
  assigneeId  String?
  dueDate     DateTime?
  coverImage  String?        // Cover image URL
  coverColor  String?        // Cover color
  emoji       String?        // Emoji icon for task
  archived    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  list        List           @relation(fields: [listId], references: [id], onDelete: Cascade)
  assignee    User?          @relation(fields: [assigneeId], references: [id])
  comments    Comment[]
  activities  Activity[]
  taskLabels  TaskLabel[]
  reactions   TaskReaction[]
  checklists  Checklist[]
  attachments Attachment[]

  @@map("task")
}

model Comment {
  id        String   @id
  content   String
  taskId    String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@map("comment")
}

// File Attachments System
model Attachment {
  id              String   @id
  taskId          String
  
  // File info
  name            String   // Original filename
  mimeType        String   // e.g., image/png, application/pdf
  size            Int      // File size in bytes
  
  // Storage info
  storageType     String   // google_drive, local, external_link
  storageId       String?  // Google Drive file ID or local path
  url             String   // Direct URL or Google Drive link
  thumbnailUrl    String?  // Thumbnail URL for images
  
  // Google Drive specific
  driveFileId     String?  // Google Drive file ID
  driveFolderId   String?  // Parent folder ID in Drive
  integrationId   String?  // Link to Google Drive integration used
  
  // Versioning
  version         Int      @default(1)
  previousVersionId String?
  
  // Metadata
  uploadedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  previousVersion Attachment? @relation("AttachmentVersions", fields: [previousVersionId], references: [id])
  nextVersions    Attachment[] @relation("AttachmentVersions")

  @@index([taskId])
  @@index([driveFileId])
  @@map("attachment")
}

model Activity {
  id          String   @id
  type        String // board_created, task_moved, member_added, etc.
  description String
  metadata    String? // JSON metadata
  boardId     String?
  taskId      String?
  userId      String
  createdAt   DateTime @default(now())
  board       Board?   @relation(fields: [boardId], references: [id], onDelete: Cascade)
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@map("activity")
}

// Labels System
model Label {
  id          String      @id
  name        String
  description String?
  color       String // Hex color code
  boardId     String
  position    Int         @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  board       Board       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  taskLabels  TaskLabel[]

  @@unique([boardId, name])
  @@map("label")
}

model TaskLabel {
  id        String   @id
  taskId    String
  labelId   String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
  @@map("task_label")
}

// Task Reactions System
model TaskReaction {
  id        String   @id
  taskId    String
  userId    String
  emoji     String   // Emoji reaction
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId, emoji])
  @@map("task_reaction")
}

// Board Templates System
model BoardTemplate {
  id            String         @id
  name          String
  description   String?
  category      String         // sprint, roadmap, calendar, bugtracking, onboarding, event, custom
  icon          String?        // Emoji or icon name
  coverImage    String?        // Template cover image
  isPredefined  Boolean        @default(false)
  isPublic      Boolean        @default(true)
  usageCount    Int            @default(0)
  rating        Float          @default(0)
  variables     String?        // JSON array of variable placeholders
  createdById   String?
  organizationId String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  lists         TemplateList[]

  @@map("board_template")
}

model TemplateList {
  id         String         @id
  name       String
  position   Int
  color      String?
  emoji      String?
  templateId String
  template   BoardTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  tasks      TemplateTask[]

  @@map("template_list")
}

model TemplateTask {
  id          String       @id
  title       String
  description String?
  position    Int
  emoji       String?
  coverColor  String?
  coverImage  String?
  labels      String?      // JSON array of label names
  variables   String?      // JSON for variable placeholders like {{assignee}}, {{date}}
  listId      String
  list        TemplateList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@map("template_task")
}

// Board Views System
model BoardView {
  id          String   @id
  boardId     String
  name        String   // "Board", "Calendar", "Table", "Timeline", "Gallery"
  type        String   // kanban, calendar, table, timeline, gallery
  isDefault   Boolean  @default(false)
  position    Int      @default(0)
  settings    String?  // JSON with view-specific settings (groupBy, sortBy, filters, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  board       Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@map("board_view")
}

// Search System
model SavedSearch {
  id          String   @id
  userId      String
  name        String
  query       String   // Search query
  filters     String?  // JSON with filters (labels, members, dates, status, etc.)
  isGlobal    Boolean  @default(false) // Search across all boards or current board
  isPinned    Boolean  @default(false)
  usageCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("saved_search")
}

model SearchHistory {
  id          String   @id
  userId      String
  query       String
  filters     String?  // JSON
  resultCount Int      @default(0)
  clickedResult String? // ID of clicked result
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@map("search_history")
}

// Checklists System
model Checklist {
  id        String         @id
  taskId    String
  name      String
  position  Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  task      Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  items     ChecklistItem[]

  @@map("checklist")
}

model ChecklistItem {
  id          String         @id
  checklistId String
  content     String         // Markdown support
  checked     Boolean        @default(false)
  position    Int            @default(0)
  assigneeId  String?
  dueDate     DateTime?
  parentId    String?        // For nested items
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  checklist   Checklist      @relation(fields: [checklistId], references: [id], onDelete: Cascade)
  assignee    User?          @relation(fields: [assigneeId], references: [id])
  parent      ChecklistItem? @relation("ChecklistItemNesting", fields: [parentId], references: [id], onDelete: Cascade)
  children    ChecklistItem[] @relation("ChecklistItemNesting")

  @@map("checklist_item")
}

model ChecklistTemplate {
  id        String   @id
  boardId   String?  // null = global template
  name      String
  items     String   // JSON array of template items
  isGlobal  Boolean  @default(false)
  usageCount Int     @default(0)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  creator   User     @relation(fields: [createdBy], references: [id])

  @@map("checklist_template")
}

// ==========================================
// INTEGRATIONS SYSTEM
// ==========================================

// Integration types: slack, github, google_drive, zapier, email, webhook
model Integration {
  id              String   @id
  type            String   // slack, github, google_drive, zapier, email, webhook
  name            String   // Display name
  description     String?
  enabled         Boolean  @default(true)
  
  // OAuth credentials (encrypted)
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?
  
  // Configuration (JSON)
  config          String   @default("{}")
  
  // Scope - can be organization-wide or board-specific
  organizationId  String?
  boardId         String?
  
  // Metadata
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastUsedAt      DateTime?
  
  // Relations
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  board           Board?        @relation(fields: [boardId], references: [id], onDelete: Cascade)
  logs            IntegrationLog[]
  webhooks        Webhook[]
  
  @@map("integration")
}

// Webhook configuration for outgoing webhooks
model Webhook {
  id            String   @id
  integrationId String
  url           String   // Webhook URL
  secret        String?  // HMAC secret for verification
  events        String   // JSON array of event types to trigger
  enabled       Boolean  @default(true)
  
  // Retry configuration
  maxRetries    Int      @default(3)
  retryDelay    Int      @default(5000) // ms
  
  // Stats
  successCount  Int      @default(0)
  failureCount  Int      @default(0)
  lastTriggered DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  deliveries    WebhookDelivery[]
  
  @@map("webhook")
}

// Track webhook delivery attempts
model WebhookDelivery {
  id           String   @id
  webhookId    String
  event        String   // Event type
  payload      String   // JSON payload sent
  
  // Response
  statusCode   Int?
  response     String?  // Response body
  duration     Int?     // ms
  
  // Status
  status       String   // pending, success, failed
  attempts     Int      @default(1)
  error        String?
  
  createdAt    DateTime @default(now())
  deliveredAt  DateTime?
  
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  @@map("webhook_delivery")
}

// Log integration activities
model IntegrationLog {
  id            String   @id
  integrationId String
  action        String   // e.g., "card_created", "notification_sent"
  status        String   // success, error, warning
  message       String?
  metadata      String?  // JSON with additional data
  
  createdAt     DateTime @default(now())
  
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  
  @@map("integration_log")
}

// API Keys for public API access
model ApiKey {
  id              String   @id
  name            String
  key             String   @unique // Hashed key
  prefix          String   // First 8 chars for display (e.g., "pk_live_")
  
  // Permissions
  scopes          String   // JSON array of allowed scopes
  
  // Rate limiting
  rateLimit       Int      @default(1000) // requests per hour
  requestCount    Int      @default(0)
  lastResetAt     DateTime @default(now())
  
  // Ownership
  organizationId  String?
  userId          String
  
  // Metadata
  lastUsedAt      DateTime?
  expiresAt       DateTime?
  enabled         Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@map("api_key")
}

// Email-to-board configuration
model EmailIntegration {
  id              String   @id
  boardId         String   @unique
  inboundEmail    String   @unique // e.g., board-abc123@boards.yourapp.com
  defaultListId   String?  // List to create cards in
  enabled         Boolean  @default(true)
  
  // Processing rules (JSON)
  rules           String   @default("[]")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  board           Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  
  @@map("email_integration")
}

